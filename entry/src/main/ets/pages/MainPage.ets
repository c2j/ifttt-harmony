import { LoadingComponent } from '../common/components/LoadingComponent';
import { appStore } from '../common/store/AppStore';
import { RouteUtils } from '../common/router/Router';
import { RulesPage } from './rules/RulesPage'
import { PluginsPage } from './plugins/PluginsPage'
import { LogsPage } from './logs/LogsPage'
import { ProfilePage } from './profile/ProfilePage';

/**
 * ä¸»é¡µé¢ - ä½¿ç”¨TabBarå¯¼èˆª
 */
@Component
export struct MainPage {
  @State currentTabIndex: number = 0;
  @State isLoading: boolean = false;
  @State showNavigationSplitView: boolean = false;

  // Tabæ ‡ç­¾æ•°æ®
  private tabsData: TabItem[] = [
    {
      index: 0,
      title: 'è§„åˆ™',
      iconText: 'âš™ï¸'
    },
    {
      index: 1,
      title: 'æ’ä»¶',
      iconText: 'ğŸ§©'
    },
    {
      index: 2,
      title: 'æ—¥å¿—',
      iconText: 'ğŸ“‹'
    },
    {
      index: 3,
      title: 'æˆ‘çš„',
      iconText: 'ğŸ‘¤'
    }
  ];

  aboutToAppear() {
    this.initializeApp();
    this.checkScreenSize();
  }

  /**
   * åˆå§‹åŒ–åº”ç”¨
   */
  private async initializeApp() {
    this.isLoading = true;
    
    try {
      // åˆå§‹åŒ–åº”ç”¨çŠ¶æ€
      console.info('[MainPage] Initializing app...');
      
      // è¿™é‡Œå¯ä»¥æ·»åŠ åˆå§‹åŒ–é€»è¾‘ï¼Œæ¯”å¦‚ï¼š
      // - æ£€æŸ¥ç½‘ç»œçŠ¶æ€
      // - åŠ è½½ç”¨æˆ·é…ç½®
      // - åŒæ­¥æ•°æ®ç­‰
      
      await this.delay(1000); // æ¨¡æ‹Ÿåˆå§‹åŒ–æ—¶é—´
      
    } catch (error) {
      console.error('[MainPage] Failed to initialize app:', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * æ£€æŸ¥å±å¹•å°ºå¯¸ï¼Œå†³å®šæ˜¯å¦ä½¿ç”¨NavigationSplitView
   */
  private checkScreenSize() {
    // è¿™é‡Œå¯ä»¥æ ¹æ®å±å¹•å°ºå¯¸å†³å®šå¸ƒå±€
    // æš‚æ—¶ä½¿ç”¨TabBarå¸ƒå±€
    this.showNavigationSplitView = false;
  }

  /**
   * å»¶è¿Ÿå‡½æ•°
   */
  private delay(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  build() {
    Stack() {
      if (this.showNavigationSplitView) {
        // å¤§å±å¹•ä½¿ç”¨NavigationSplitView
        this.buildNavigationSplitView();
      } else {
        // å°å±å¹•ä½¿ç”¨TabBar
        this.buildTabBarView();
      }

      // å…¨å±€åŠ è½½ç»„ä»¶
      LoadingComponent({
        visible: this.isLoading,
        message: 'åˆå§‹åŒ–ä¸­...'
      })
    }
    .width('100%')
    .height('100%')
  }

  /**
   * æ„å»ºTabBarè§†å›¾
   */
  @Builder
  buildTabBarView() {
    Tabs({
      barPosition: BarPosition.End,
      index: this.currentTabIndex
    }) {
      ForEach(this.tabsData, (item: TabItem) => {
        TabContent() {
          this.buildTabContent(item.index)
        }
        .tabBar(this.buildTabBar(item))
      })
    }
    .width('100%')
    .height('100%')
    .barBackgroundColor(Color.White)
    .onChange((index: number) => {
      this.currentTabIndex = index;
      console.info(`[MainPage] Tab changed to: ${index}`);
    })
  }

  /**
   * æ„å»ºNavigationSplitViewï¼ˆå¤§å±å¹•ï¼‰
   */
  @Builder
  buildNavigationSplitView() {
    Row() {
      // ä¾§è¾¹æ 
      Column({ space: 8 }) {
        ForEach(this.tabsData, (item: TabItem) => {
          this.buildSideBarItem(item)
        })
      }
      .width(200)
      .height('100%')
      .padding(16)
      .backgroundColor('#F5F5F5')

      // ä¸»å†…å®¹åŒº
      Column() {
        this.buildTabContent(this.currentTabIndex)
      }
      .layoutWeight(1)
      .height('100%')
      .backgroundColor(Color.White)
    }
    .width('100%')
    .height('100%')
  }

  /**
   * æ„å»ºTabæ ‡ç­¾
   */
  @Builder
  buildTabBar(item: TabItem) {
    Column({ space: 4 }) {
      Text(item.iconText)
        .fontSize(20)
        .fontColor(this.currentTabIndex === item.index ? Color.Blue : Color.Gray)

      Text(item.title)
        .fontSize(12)
        .fontColor(this.currentTabIndex === item.index ? Color.Blue : Color.Gray)
    }
    .width('100%')
    .height(56)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  /**
   * æ„å»ºä¾§è¾¹æ é¡¹ç›®
   */
  @Builder
  buildSideBarItem(item: TabItem) {
    Row({ space: 12 }) {
      Text(item.iconText)
        .fontSize(18)
        .fontColor(this.currentTabIndex === item.index ? Color.Blue : Color.Gray)

      Text(item.title)
        .fontSize(16)
        .fontColor(this.currentTabIndex === item.index ? Color.Blue : Color.Black)
        .fontWeight(this.currentTabIndex === item.index ? FontWeight.Medium : FontWeight.Normal)
    }
    .width('100%')
    .height(48)
    .padding({ left: 16, right: 16 })
    .borderRadius(8)
    .backgroundColor(this.currentTabIndex === item.index ? '#E3F2FD' : Color.Transparent)
    .onClick(() => {
      this.currentTabIndex = item.index;
    })
  }

  /**
   * æ„å»ºTabå†…å®¹
   */
  @Builder
  buildTabContent(index: number) {
    if (index === 0) {
      this.buildRulesPage();
    } else if (index === 1) {
      this.buildPluginsPage();
    } else if (index === 2) {
      this.buildLogsPage();
    } else if (index === 3) {
      this.buildProfilePage();
    } else {
      this.buildDefaultPage();
    }
  }

  /**
   * è§„åˆ™é¡µé¢
   */
  @Builder
  buildRulesPage() {
    RulesPage()
  }

  /**
   * æ’ä»¶é¡µé¢
   */
  @Builder
  buildPluginsPage() {
    Column() {
      PluginsPage()
    }
  }

  /**
   * æ—¥å¿—é¡µé¢
   */
  @Builder
  buildLogsPage() {
    Column() {
      LogsPage()
    }
  }

  /**
   * ä¸ªäººä¸­å¿ƒé¡µé¢
   */
  @Builder
  buildProfilePage() {
    Column() {
      ProfilePage()
    }
  }

  /**
   * é»˜è®¤é¡µé¢
   */
  @Builder
  buildDefaultPage() {
    Column() {
      Text('é¡µé¢å¼€å‘ä¸­...')
        .fontSize(16)
        .fontColor(Color.Gray)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .backgroundColor('#F8F9FA')
  }
}

/**
 * Tabé¡¹ç›®æ¥å£
 */
interface TabItem {
  index: number;
  title: string;
  iconText: string;
}
