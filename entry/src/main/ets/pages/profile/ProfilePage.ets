import { AppStore } from '../../common/store/AppStore'
import { LoadingComponent } from '../../common/components/LoadingComponent'

/**
 * èœå•é¡¹æ¥å£
 */
interface MenuItem {
  title: string;
  icon: string;
  action: () => void;
}

/**
 * ç”¨æˆ·ä¿¡æ¯æ¥å£
 */
interface UserInfo {
  name: string;
  nickname: string;
  email: string;
  phone: string;
  avatar: string;
  deviceId: string;
  version: string;
  rulesCount: number;
  pluginsCount: number;
  executionsCount: number;
}

@Entry
@Component
export struct ProfilePage {
  @StorageLink('appStore') appStore: AppStore = AppStore.getInstance()
  @State userInfo: UserInfo | null = null
  @State isLoading: boolean = false
  
  aboutToAppear() {
    this.loadUserInfo()
  }
  
  async loadUserInfo() {
    this.isLoading = true
    try {
      // TODO: è°ƒç”¨ API è·å–ç”¨æˆ·ä¿¡æ¯
      // æ¨¡æ‹Ÿæ•°æ®
      this.userInfo = {
        name: 'ç”¨æˆ·123456',
        nickname: 'ç”¨æˆ·123456',
        avatar: '',
        email: 'user@example.com',
        phone: '138****8888',
        deviceId: 'device123',
        version: '1.0.0',
        rulesCount: 12,
        pluginsCount: 8,
        executionsCount: 156
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  build() {
    Column() {
      if (this.isLoading) {
        LoadingComponent()
      } else {
        // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
        Column() {
          Row() {
            // å¤´åƒ
            Image(this.userInfo?.avatar || $r('app.media.startIcon'))
              .width(60)
              .height(60)
              .borderRadius(30)
              .margin({ right: 16 })
            
            // ç”¨æˆ·ä¿¡æ¯
            Column() {
              Text(this.userInfo?.nickname || 'æœªç™»å½•')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
              
              Text(this.userInfo?.email || '')
                .fontSize(14)
                .fontColor('#666666')
                .margin({ top: 4 })
            }
            .alignItems(HorizontalAlign.Start)
            .flexGrow(1)
            
            // ç¼–è¾‘æŒ‰é’®
            Button('ç¼–è¾‘')
              .fontSize(14)
              .backgroundColor('#F0F0F0')
              .fontColor('#333333')
              .borderRadius(6)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .onClick(() => this.editProfile())
          }
          .width('100%')
          .alignItems(VerticalAlign.Center)
          
          // ç»Ÿè®¡ä¿¡æ¯
          Row() {
            Column() {
              Text(this.userInfo?.rulesCount?.toString() || '0')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#007AFF')
              Text('è§„åˆ™æ•°')
                .fontSize(12)
                .fontColor('#666666')
                .margin({ top: 4 })
            }
            .flexGrow(1)
            
            Column() {
              Text(this.userInfo?.pluginsCount?.toString() || '0')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#52C41A')
              Text('æ’ä»¶æ•°')
                .fontSize(12)
                .fontColor('#666666')
                .margin({ top: 4 })
            }
            .flexGrow(1)
            
            Column() {
              Text(this.userInfo?.executionsCount?.toString() || '0')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FF6B35')
              Text('æ‰§è¡Œæ¬¡æ•°')
                .fontSize(12)
                .fontColor('#666666')
                .margin({ top: 4 })
            }
            .flexGrow(1)
          }
          .width('100%')
          .margin({ top: 20 })
        }
        .width('100%')
        .backgroundColor(Color.White)
        .borderRadius(12)
        .padding(20)
        .margin({ bottom: 20 })
        .shadow({
          radius: 8,
          color: '#00000010',
          offsetX: 0,
          offsetY: 2
        })
        
        // åŠŸèƒ½èœå•
        Column() {
          this.MenuSection('è´¦æˆ·è®¾ç½®', this.createAccountMenuItems())
          
          this.MenuSection('æ•°æ®ç®¡ç†', this.createDataMenuItems())
          
          this.MenuSection('å…¶ä»–', this.createOtherMenuItems())
          
          // é€€å‡ºç™»å½•æŒ‰é’®
          Button('é€€å‡ºç™»å½•')
            .width('100%')
            .height(48)
            .fontSize(16)
            .backgroundColor('#FF4D4F')
            .borderRadius(8)
            .margin({ top: 20 })
            .onClick(() => this.logout())
        }
        .width('100%')
      }
    }
    .width('100%')
    .height('100%')
    .padding(16)
    .backgroundColor('#F5F5F5')
  }
  
  @Builder
  MenuSection(title: string, items: MenuItem[]) {
    Column() {
      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)
      
      Column() {
        ForEach(items, (item: MenuItem, index: number) => {
          Row() {
            Text(item.icon)
              .fontSize(20)
              .margin({ right: 12 })
            
            Text(item.title)
              .fontSize(16)
              .flexGrow(1)
            
            Text('>')
              .fontSize(16)
              .fontColor('#CCCCCC')
          }
          .width('100%')
          .height(48)
          .padding({ left: 16, right: 16 })
          .onClick(item.action)
          
          if (index < items.length - 1) {
            Divider()
              .color('#F0F0F0')
              .margin({ left: 48 })
          }
        })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(8)
    }
    .width('100%')
    .margin({ bottom: 20 })
  }

  /**
   * åˆ›å»ºè´¦æˆ·è®¾ç½®èœå•é¡¹
   */
  private createAccountMenuItems(): MenuItem[] {
    return [
      this.createMenuItem('ä¸ªäººä¿¡æ¯', 'ğŸ‘¤', () => this.editProfile()),
      this.createMenuItem('å®‰å…¨è®¾ç½®', 'ğŸ”’', () => this.securitySettings()),
      this.createMenuItem('é€šçŸ¥è®¾ç½®', 'ğŸ””', () => this.notificationSettings())
    ];
  }

  /**
   * åˆ›å»ºæ•°æ®ç®¡ç†èœå•é¡¹
   */
  private createDataMenuItems(): MenuItem[] {
    return [
      this.createMenuItem('å¤‡ä»½æ•°æ®', 'â˜ï¸', () => this.backupData()),
      this.createMenuItem('æ¢å¤æ•°æ®', 'ğŸ“¥', () => this.restoreData()),
      this.createMenuItem('æ¸…é™¤ç¼“å­˜', 'ğŸ—‘ï¸', () => this.clearCache())
    ];
  }

  /**
   * åˆ›å»ºå…¶ä»–èœå•é¡¹
   */
  private createOtherMenuItems(): MenuItem[] {
    return [
      this.createMenuItem('å¸®åŠ©ä¸­å¿ƒ', 'â“', () => this.helpCenter()),
      this.createMenuItem('æ„è§åé¦ˆ', 'ğŸ’¬', () => this.feedback()),
      this.createMenuItem('å…³äºåº”ç”¨', 'â„¹ï¸', () => this.aboutApp())
    ];
  }

  /**
   * åˆ›å»ºèœå•é¡¹
   */
  private createMenuItem(title: string, icon: string, action: () => void): MenuItem {
    return {
      title: title,
      icon: icon,
      action: action
    };
  }

  editProfile(): void {
    console.log('ç¼–è¾‘ä¸ªäººä¿¡æ¯')
    // TODO: è·³è½¬åˆ°ç¼–è¾‘é¡µé¢
  }

  securitySettings(): void {
    console.log('å®‰å…¨è®¾ç½®')
    // TODO: è·³è½¬åˆ°å®‰å…¨è®¾ç½®é¡µé¢
  }

  notificationSettings(): void {
    console.log('é€šçŸ¥è®¾ç½®')
    // TODO: è·³è½¬åˆ°é€šçŸ¥è®¾ç½®é¡µé¢
  }

  backupData(): void {
    console.log('å¤‡ä»½æ•°æ®')
    // TODO: å®ç°æ•°æ®å¤‡ä»½
  }

  restoreData(): void {
    console.log('æ¢å¤æ•°æ®')
    // TODO: å®ç°æ•°æ®æ¢å¤
  }

  clearCache(): void {
    console.log('æ¸…é™¤ç¼“å­˜')
    // TODO: å®ç°æ¸…é™¤ç¼“å­˜
  }

  helpCenter(): void {
    console.log('å¸®åŠ©ä¸­å¿ƒ')
    // TODO: è·³è½¬åˆ°å¸®åŠ©ä¸­å¿ƒ
  }

  feedback(): void {
    console.log('æ„è§åé¦ˆ')
    // TODO: è·³è½¬åˆ°åé¦ˆé¡µé¢
  }

  aboutApp(): void {
    console.log('å…³äºåº”ç”¨')
    // TODO: æ˜¾ç¤ºåº”ç”¨ä¿¡æ¯
  }
  
  logout() {
    console.log('é€€å‡ºç™»å½•')
    // TODO: å®ç°é€€å‡ºç™»å½•
  }
}
